"use client";

import { useState, useEffect } from 'react';
import {
	KanbanBoard,
	KanbanCard,
	KanbanCards,
	KanbanHeader,
	KanbanProvider,
} from "@/components/ui/shadcn-io/kanban";
import { Task } from "@/lib/types";
import TaskSheet from './sheet';
import { Plus } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';

const columns = [
	{ id: "open", name: "Open", color: "#6B7280" },
	{ id: "in-progress", name: "In Progress", color: "#F59E0B" },
	{ id: "done", name: "Done", color: "#10B981" },
];

interface PropType {
	data: Task[];
}

export default function ProjectTasksKanban({ data }: PropType) {
  const [tasks, setTasks] = useState<Task[]>(data || []);
  const [isOpenSheet, setIsOpenSheet] = useState<boolean>(false);
  const [selectedTask, setSelectedTask] = useState<Task | null>(null);
  const [editableCard, setEditableCard] = useState<string | null>(null);

  useEffect(() => {
    if(!data) return;
    setTasks(data);
  }, [data])

  const mappedTasks = tasks.map(task => ({
    ...task,
    id: task.id.toString(),
    name: task.title,
    column: task.status === "done" ? "done" : task.status === "in-progress" ? "in-progress" : "open"
  }));

  function onCardClick(task: Task) {
    setSelectedTask(task);
    setIsOpenSheet(true);
  }

	return (
		<div >
			<KanbanProvider columns={columns} data={mappedTasks}>
				{(column) => (
					<KanbanBoard id={column.id} key={column.id}>
						<KanbanHeader>
							<div className="flex items-center gap-2">
								<div
									className="h-2 w-2 rounded-full"
									style={{ backgroundColor: column.color }}
								/>
								<span>{column.name}</span>
                <Button className="bg-transparent hover:bg-transparen text-gray-500 hover:text-black transition-colors outline-none p-0 shadow-none cursor-pointer">
                  <Plus height={20} width={20}/>
                </Button>
							</div>

              
						</KanbanHeader>
						<KanbanCards id={column.id}>
							{(task) => (
								<KanbanCard column={column.name} key={task.id} id={task.id} name={task.name} >
                  <div key={task.id} onPointerDown={(e) => e.stopPropagation()} onClick={() => onCardClick(task)} className="top-0 w-full h-full">

									<div className="">
                    <Input type="text" value={task.name} className=" disabled:opacity-100 disabled:text-black disabled:bg-transparent disabled:border-none disabled:shadow-none border-none bg-transparent shadow-none outline-none" disabled={editableCard == task.id? false : true}/>
									</div>
                  </div>
								</KanbanCard>
							)}
						</KanbanCards>
					</KanbanBoard>
				)}
			</KanbanProvider>

      <TaskSheet  data={selectedTask} isOpen={isOpenSheet} setIsOpen={setIsOpenSheet}/>

		</div>
	);
}
